<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Accelerometer Javascript Test</title>
    <meta name="viewport" content="width=device-width,user-scalable=yes" />
    <style>
      body {
        font-family: helvetica, arial, sans serif;
      }
      #sphere {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50px;
        -webkit-radius: 50px;
        background-color: blue;
      }
    </style>
  </head>

  <body>
    <div id="content">
      <div id="sphere"></div>

      <h1>Drop me to trigger alert!</h1>
      <p><strong>X:</strong> <span id="accelerationX">0.0</span></p>
      <p><strong>Y:</strong> <span id="accelerationY">0.0</span></p>

      <p><strong>X EMA:</strong> <span id="xArrayEma">0.0</span></p>
      <p><strong>Y EMA:</strong> <span id="yArrayEma">0.0</span></p>

      <p><strong>X Length:</strong> <span id="xArrayLength">0.0</span></p>
      <p><strong>Y Length:</strong> <span id="yArrayLength">0.0</span></p>

      <p><strong>X Values:</strong> <span id="xArray">0.0</span></p>
      <p><strong>Y Values:</strong> <span id="yArray">0.0</span></p>
    </div>

    <script type="text/javascript">
      var x = 0, y = 0,
        vx = 0, vy = 0,
        ax = 0, ay = 0;

      var n = 100; // Maximum size to calc EMA
      var EMARange = 21; // Sample size for EMA
      var xArray = [];
      var yArray = [];
      var alertSent = false;

      xArray.push(1);

      var sphere = document.getElementById("sphere");

      if (window.DeviceMotionEvent != undefined) {
        window.ondevicemotion = function(e) {
          ax = event.accelerationIncludingGravity.x * 5;
          ay = event.accelerationIncludingGravity.y * 5;
          document.getElementById("accelerationX").innerHTML = e.accelerationIncludingGravity.x;
          document.getElementById("accelerationY").innerHTML = e.accelerationIncludingGravity.y;

          // Write X and Y to array
          xArray.push(e.accelerationIncludingGravity.x);
          yArray.push(e.accelerationIncludingGravity.y);

          if ((e.accelerationIncludingGravity.x > 2.5) && (alertSent == false)) {
            console.log("Phone Dropped!");
            alertSent = true;
          }

          // If array is over N, prune the first figure
          if (xArray.length > n) {
            xArray.shift();
          }
          if (yArray.length > n) {
            yArray.shift();
          }

          // Write array to page
          document.getElementById("xArrayLength").innerHTML = xArray.length;
          document.getElementById("yArrayLength").innerHTML = yArray.length;

          document.getElementById("xArrayEma").innerHTML = sumArray(diff(xArray));
          document.getElementById("yArrayEma").innerHTML = sumArray(diff(yArray));


          document.getElementById("xArray").innerHTML = xArray;
          document.getElementById("yArray").innerHTML = xArray;
        }

        setInterval( function() {
          var landscapeOrientation = window.innerWidth/window.innerHeight > 1;
          if ( landscapeOrientation) {
            vx = vx + ay;
            vy = vy + ax;
          } else {
            vy = vy - ay;
            vx = vx + ax;
          }
          vx = vx * 0.98;
          vy = vy * 0.98;
          y = parseInt(y + vy / 50);
          x = parseInt(x + vx / 50);

          boundingBoxCheck();

          sphere.style.top = y + "px";
          sphere.style.left = x + "px";

        }, 25);
      }

      function boundingBoxCheck(){
        if (x<0) { x = 0; vx = -vx; }
        if (y<0) { y = 0; vy = -vy; }
        if (x>document.documentElement.clientWidth-20) { x = document.documentElement.clientWidth-20; vx = -vx; }
        if (y>document.documentElement.clientHeight-20) { y = document.documentElement.clientHeight-20; vy = -vy; }
      }

      function diff(ary) {
        var newA = [];
        for (var i = 1; i < ary.length; i++)  newA.push(ary[i] - ary[i - 1])
        return newA;
      }

      function sumArray(array) {
        for (
          var
          index = 0,              // The iterator
          length = array.length,  // Cache the array length
          sum = 0;                // The total amount
          index < length;         // The "for"-loop condition
          sum += array[index++]   // Add number on each iteration
        );
        return sum;
      }

      function EMACalc(mArray,mRange) {
        var k = 2/(mRange + 1);
        // first item is just the same as the first item in the input
        emaArray = [mArray[0]];
        // for the rest of the items, they are computed with the previous one
        for (var i = 1; i < mArray.length; i++) {
          emaArray.push(mArray[i] * k + emaArray[i - 1] * (1 - k));
        }
        return emaArray;
      }
    </script>

  </body>
</html>
